<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily University Planner</title>
  <style>
    /* =============================
       THEME TOKENS (Light & Dark)
       ============================= */
    :root {
      --bg: #ffffff;
      --card: #fafafa;
      --muted: #f7f6f3;
      --muted-strong: #f1f1ef;
      --text: #37352f;
      --text-muted: #787774;
      --border: #e9e9e7;
      --accent: #2383e2;
      --accent-contrast: #ffffff;
      --danger: #ff4757;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.06);
    }
    [data-theme="dark"] {
      --bg: #1f1f1f;
      --card: #262626;
      --muted: #2c2c2c;
      --muted-strong: #333333;
      --text: #e7e7e7;
      --text-muted: #b5b5b5;
      --border: #3a3a3a;
      --accent: #4ca3ff;
      --accent-contrast: #0f172a;
      --danger: #ff6b6b;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      --shadow-sm: 0 3px 12px rgba(0, 0, 0, 0.25);
    }

    /* =============================
       GLOBAL RESETS & BASE
       ============================= */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 32px 16px 48px;
    }
    .container { max-width: 1000px; margin: 0 auto; position: relative; }

    /* Header */
    .header-section {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; gap: 16px;
    }
    .time-header { flex: 1; }
    .time-small { font-size: 14px; color: var(--text-muted); margin-bottom: 4px; font-weight: 400; }
    .day-date { font-size: 16px; color: var(--text); margin-bottom: 8px; font-weight: 600; }
    .current-time { font-size: 48px; font-weight: 700; color: var(--text); margin-bottom: 12px;
      font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', 'Courier New', monospace; }

    .toolbar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 4px;
    }
    .btn {
      border: 1px solid var(--border); background: var(--muted); color: var(--text); padding: 6px 10px; border-radius: 10px;
      font-size: 12px; cursor: pointer; transition: transform .06s ease, background .2s ease, border-color .2s ease; box-shadow: var(--shadow-sm);
    }
    .btn:hover { transform: translateY(-1px); border-color: var(--accent); }
    .btn.primary { background: var(--accent); color: var(--accent-contrast); border-color: var(--accent); }
    .btn.danger { background: var(--danger); color: white; border-color: var(--danger); }
    .btn.ghost { background: transparent; }

    .mini-calendar { background: var(--muted); border-radius: 12px; padding: 12px; width: 240px; box-shadow: var(--shadow); }
    .calendar-header { text-align: center; font-weight: 700; font-size: 14px; margin-bottom: 8px; color: var(--text); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .calendar-day { text-align: center; padding: 6px 2px; font-size: 12px; color: var(--text-muted); border-radius: 6px; }
    .calendar-day.header { font-weight: 700; color: var(--text); font-size: 11px; }
    .calendar-day.current { background: var(--accent); color: var(--accent-contrast); font-weight: 800; }
    .calendar-day.other-month { color: #a9a9a9; opacity: .7; }

    /* Progress */
    .progress-section { margin: 16px 0 28px; padding: 16px 0; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
    .progress-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .progress-label { font-size: 14px; color: var(--text); font-weight: 600; }
    .progress-percent { font-size: 14px; color: var(--text-muted); font-weight: 500; }
    .progress-container { width: 100%; height: 8px; background: var(--muted-strong); border-radius: 999px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--accent); border-radius: 999px; transition: width 0.6s ease; }

    /* Schedule */
    .schedule-section { margin-bottom: 32px; position: relative; }
    .section-title { font-size: 20px; font-weight: 800; color: var(--text); margin-bottom: 12px; display:flex; align-items:center; gap:10px; }
    .schedule-grid { position: relative; background: var(--card); border-radius: 14px; padding: 20px; min-height: 520px; box-shadow: var(--shadow); }

    .time-divider { position: absolute; left: 0; right: 0; height: 1px; border-top: 2px dotted var(--border); z-index: 1; }
    .time-divider.am { top: 25%; }
    .time-divider.pm { top: 50%; }
    .time-divider::before { content: attr(data-time); position: absolute; left: 10px; top: -10px; background: var(--card); padding: 0 8px; font-size: 12px; color: var(--text-muted); font-weight: 700; }

    .time-progress-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--danger); z-index: 10; transition: top 0.5s ease; border-radius: 1px; }
    .time-progress-line::before { content: ''; position: absolute; left: -4px; top: -2px; width: 8px; height: 6px; background: var(--danger); border-radius: 50%; }

    .time-row { display: flex; align-items: flex-start; margin-bottom: 12px; position: relative; z-index: 5; }
    .time-label { font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', 'Courier New', monospace; font-size: 12px; color: var(--text-muted); font-weight: 700; width: 60px; flex-shrink: 0; margin-right: 12px; text-align: right; padding-top: 6px; }
    .events-container { flex: 1; display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start; }

    .event-block { background: var(--muted); border: 2px solid transparent; border-radius: 10px; padding: 8px 12px 10px 12px; cursor: move; transition: all 0.15s ease, transform .06s ease; position: relative; min-width: 160px; max-width: 280px; box-shadow: var(--shadow-sm); }
    .event-block:hover { border-color: var(--border); transform: translateY(-1px); }
    .event-block.dragging { opacity: 0.8; transform: rotate(2deg) scale(1.02); z-index: 1000; box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25); }
    .event-block.current { outline: 2px solid var(--accent); }
    .event-block.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(35,131,226,0.15); }

    .event-top { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
    .pill { font-size: 10px; padding: 2px 6px; border-radius: 999px; border: 1px solid var(--border); background: var(--card); color: var(--text-muted); cursor: pointer; }
    .pill.select { padding: 2px 6px; }
    .event-content { font-size: 14px; color: var(--text); font-weight: 600; background: transparent; border: none; outline: none; width: 100%; }
    .event-content::placeholder { color: #a9a9a9; }

    .delete-btn { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
    .event-block:hover .delete-btn { display: flex; }

    .add-event-btn { background: transparent; border: 2px dashed var(--border); color: var(--text-muted); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 12px; transition: all 0.15s ease; min-width: 140px; }
    .add-event-btn:hover { border-color: var(--accent); color: var(--accent); }

    .drop-zone { min-height: 30px; border: 2px dashed transparent; border-radius: 10px; transition: all 0.15s ease; }
    .drop-zone.drag-over { border-color: var(--accent); background: rgba(35,131,226,0.06); }

    /* Category colors */
    .cat-study { background: rgba(35,131,226,0.10); }
    .cat-meal { background: rgba(255,170,0,0.12); }
    .cat-exercise { background: rgba(46,213,115,0.14); }
    .cat-admin { background: rgba(156,136,255,0.14); }
    .cat-break { background: rgba(255,107,107,0.12); }
    .cat-other { background: var(--muted); }

    /* Stats */
    .stats-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    .stat-item { text-align: center; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: var(--shadow-sm); }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--text); margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; }

    /* Add time slot */
    .time-tools { display:flex; align-items:center; gap:8px; margin-bottom: 12px; }
    .input { height: 32px; padding: 0 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); font-size: 13px; }

    /* Help Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.35); z-index: 2000; }
    .modal.open { display: flex; }
    .modal-card { width: min(680px, 92%); background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 16px; }
    .modal-card h3 { margin-bottom: 8px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; padding: 3px 6px; border: 1px solid var(--border); border-radius: 6px; background: var(--muted); font-size: 12px; }

    @media (max-width: 850px) {
      .header-section { flex-direction: column; }
      .mini-calendar { width: 100%; }
      .current-time { font-size: 40px; }
      .stats-section { grid-template-columns: 1fr; gap: 12px; }
      .event-block { min-width: 120px; max-width: 240px; }
    }

    /* Print styles */
    @media print {
      .toolbar, .time-tools, .delete-btn, .add-event-btn, .modal { display: none !important; }
      body { padding: 0; }
      .container { max-width: 100%; }
      .schedule-grid { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-section">
      <div class="time-header">
        <div class="time-small" id="timeSmall">00:00</div>
        <div class="day-date" id="dayDate">Sunday (01|01|25)</div>
        <div class="current-time" id="currentTime">12:00:00</div>
        <div class="toolbar">
          <button class="btn" id="toggleThemeBtn" title="Toggle dark mode (D)">🌙 / ☀️ Theme</button>
          <button class="btn" id="helpBtn" title="Shortcuts & tips">❓ Help</button>
          <button class="btn" id="saveBtn" title="Force save (Ctrl+S)">💾 Save</button>
          <button class="btn" id="exportJsonBtn" title="Export JSON">⬇️ Export JSON</button>
          <button class="btn" id="exportTextBtn" title="Export text summary">📝 Export Text</button>
          <button class="btn" id="printBtn" title="Print or Save as PDF">🖨️ Print</button>
        </div>
      </div>
      <div class="mini-calendar" id="miniCalendar"></div>
    </div>

    <div class="progress-section">
      <div class="progress-info">
        <div class="progress-label">Day Progress</div>
        <div class="progress-percent" id="progressPercent">0%</div>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>

    <div class="schedule-section">
      <h2 class="section-title">Today's Schedule <span class="time-badge" id="tzBadge"></span></h2>

      <div class="time-tools">
        <input class="input" id="timeInput" type="time" step="300" />
        <button class="btn" id="addTimeSlotBtn">+ Add Time Slot</button>
        <button class="btn ghost" id="clearEmptySlotsBtn" title="Remove unused time rows">🧹 Clean empty rows</button>
      </div>

      <div class="schedule-grid" id="scheduleGrid">
        <div class="time-divider am" data-time="12:00 PM"></div>
        <div class="time-divider pm" data-time="12:00 AM"></div>
        <div class="time-progress-line" id="timeProgressLine"></div>
        <!-- Schedule rows will be populated here -->
      </div>
    </div>

    <div class="stats-section">
      <div class="stat-item">
        <div class="stat-value" id="hoursRemaining">12</div>
        <div class="stat-label">Hours Remaining</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="minutesElapsed">720</div>
        <div class="stat-label">Minutes Elapsed</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="eventsCount">0</div>
        <div class="stat-label">Events Today</div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="helpModal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3>Shortcuts & Tips</h3>
        <button class="btn" id="closeHelp">✕</button>
      </div>
      <ul style="margin-left: 18px; line-height: 1.9;">
        <li><span class="kbd">N</span> — Add an event at the nearest upcoming 30‑minute slot</li>
        <li><span class="kbd">Delete</span> — Delete the selected event</li>
        <li><span class="kbd">D</span> — Toggle dark/light theme</li>
        <li><span class="kbd">C</span> — Cycle category on selected event</li>
        <li><span class="kbd">R</span> — Cycle repeat: None → Daily → Weekdays → Weekly</li>
        <li><span class="kbd">Ctrl + S</span> — Save now</li>
        <li>Edit event text and press <span class="kbd">Enter</span> to save.</li>
        <li>Drag & drop events to a different time row to reschedule.</li>
      </ul>
    </div>
  </div>

  <script>
    // =============================
    // UTIL & STORAGE
    // =============================
    const STORAGE_KEYS = {
      schedule: 'planner.schedule.v2',
      times: 'planner.times.v2',
      theme: 'planner.theme.v1'
    };

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEYS.schedule, JSON.stringify(scheduleData));
      localStorage.setItem(STORAGE_KEYS.times, JSON.stringify(Array.from(timeSlots)));
      localStorage.setItem(STORAGE_KEYS.theme, document.documentElement.getAttribute('data-theme'));
      updateStats();
    }

    function loadFromStorage() {
      try {
        const s = JSON.parse(localStorage.getItem(STORAGE_KEYS.schedule) || 'null');
        const t = JSON.parse(localStorage.getItem(STORAGE_KEYS.times) || 'null');
        const theme = localStorage.getItem(STORAGE_KEYS.theme);
        if (Array.isArray(s)) scheduleData = s;
        if (Array.isArray(t)) timeSlots = new Set(t);
        if (theme) document.documentElement.setAttribute('data-theme', theme);
      } catch (e) { console.warn('Storage load error', e); }
    }

    // =============================
    // INITIAL DATA
    // =============================
    let scheduleData = [
      { id: 1, time: '08:00', content: 'Morning Routine', category: 'other', repeat: 'daily' },
      { id: 2, time: '08:00', content: 'Breakfast', category: 'meal', repeat: 'daily' },
      { id: 3, time: '09:00', content: 'Mathematics Lecture', category: 'study', repeat: 'weekly' },
      { id: 4, time: '10:30', content: 'Study Break', category: 'break', repeat: 'weekdays' },
      { id: 5, time: '11:00', content: 'Computer Science Lab', category: 'study', repeat: 'weekly' },
      { id: 6, time: '12:30', content: 'Lunch Break', category: 'meal', repeat: 'daily' },
      { id: 7, time: '12:30', content: 'Drink Water', category: 'other', repeat: 'daily' },
      { id: 8, time: '14:00', content: 'Physics Tutorial', category: 'study', repeat: 'weekly' },
      { id: 9, time: '15:30', content: 'Library Study', category: 'study', repeat: 'weekdays' },
      { id: 10, time: '17:00', content: 'Gym', category: 'exercise', repeat: 'weekdays' },
      { id: 11, time: '18:30', content: 'Dinner', category: 'meal', repeat: 'daily' },
      { id: 12, time: '19:30', content: 'Assignment Work', category: 'study', repeat: 'weekdays' },
      { id: 13, time: '21:00', content: 'Free Time', category: 'break', repeat: 'none' },
      { id: 14, time: '22:30', content: 'Prepare for Tomorrow', category: 'admin', repeat: 'daily' }
    ];

    // Track next ID
    let nextId = Math.max(...scheduleData.map(e => e.id)) + 1;

    // Time slots set (drives which rows are visible) — start from events' times
    let timeSlots = new Set(scheduleData.map(e => e.time));

    // Apply persisted state if available
    loadFromStorage();
    if (!Number.isFinite(nextId)) nextId = 1;

    // Active event (for keyboard shortcuts)
    let activeEventId = null;

    // Categories & repeats
    const CATEGORIES = ['study', 'meal', 'exercise', 'admin', 'break', 'other'];
    const REPEATS = ['none', 'daily', 'weekdays', 'weekly'];

    function categoryLabel(cat) {
      return {
        study: 'Study', meal: 'Meal', exercise: 'Exercise', admin: 'Admin', break: 'Break', other: 'Other'
      }[cat] || 'Other';
    }

    function repeatLabel(r) {
      return { none: 'None', daily: 'Daily', weekdays: 'Weekdays', weekly: 'Weekly' }[r] || 'None';
    }

    // =============================
    // CALENDAR & CLOCK
    // =============================
    function createMiniCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const today = now.getDate();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const daysOfWeek = ['Su','Mo','Tu','We','Th','Fr','Sa'];
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();

      let html = `<div class="calendar-header">${monthNames[month]} ${year}</div><div class="calendar-grid">`;
      daysOfWeek.forEach(d => html += `<div class="calendar-day header">${d}</div>`);
      for (let i = firstDay - 1; i >= 0; i--) { html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`; }
      for (let d = 1; d <= daysInMonth; d++) {
        const cls = d === today ? 'calendar-day current' : 'calendar-day';
        html += `<div class="${cls}">${d}</div>`;
      }
      // Fill to complete weeks grid (up to 42 cells incl. headers)
      const used = firstDay + daysInMonth;
      const remain = (Math.ceil(used / 7) * 7) - used;
      for (let d = 1; d <= remain; d++) html += `<div class="calendar-day other-month">${d}</div>`;
      html += '</div>';
      document.getElementById('miniCalendar').innerHTML = html;
    }

    function updateTime() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      document.getElementById('timeSmall').textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
      document.getElementById('currentTime').textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const dayName = days[now.getDay()];
      const day = pad(now.getDate());
      const month = pad(now.getMonth() + 1);
      const year = String(now.getFullYear()).slice(-2);
      document.getElementById('dayDate').textContent = `${dayName} (${day}|${month}|${year})`;

      // Progress bar
      const total = 24 * 60; const current = now.getHours()*60 + now.getMinutes();
      const pct = (current / total) * 100;
      document.getElementById('progressBar').style.width = `${pct}%`;
      document.getElementById('progressPercent').textContent = `${Math.round(pct)}%`;

      // Red time line position relative to schedule grid
      const grid = document.getElementById('scheduleGrid');
      const gridRect = grid.getBoundingClientRect();
      const gridHeight = grid.clientHeight - 40; // padding estimate
      const pos = (current / total) * gridHeight + 20;
      document.getElementById('timeProgressLine').style.top = `${pos}px`;

      const hrsRemaining = Math.ceil((total - current) / 60);
      document.getElementById('hoursRemaining').textContent = hrsRemaining;
      document.getElementById('minutesElapsed').textContent = current;

      // Highlight near-current events
      updateScheduleHighlight(now);
    }

    function updateScheduleHighlight(now) {
      const currentMinuteOfDay = now.getHours()*60 + now.getMinutes();
      document.querySelectorAll('.event-block').forEach(b => b.classList.remove('current'));
      scheduleData.forEach(item => {
        const [h,m] = item.time.split(':').map(Number);
        const t = h*60 + m;
        if (Math.abs(currentMinuteOfDay - t) < 30) {
          const el = document.getElementById(`event-${item.id}`);
          if (el) el.classList.add('current');
        }
      });
    }

    // =============================
    // SCHEDULE RENDERING
    // =============================
    function groupEventsByTime(events) {
      const grouped = {};
      events.forEach(e => {
        if (!grouped[e.time]) grouped[e.time] = [];
        grouped[e.time].push(e);
      });
      return grouped;
    }

    function createSchedule() {
      const container = document.getElementById('scheduleGrid');
      const keep = container.innerHTML.split('<!-- Schedule rows')[0] + '<!-- Schedule rows will be populated here -->';
      container.innerHTML = keep;

      // Merge explicit timeSlots with any times referenced by events
      scheduleData.forEach(e => timeSlots.add(e.time));

      const allTimes = Array.from(timeSlots).sort();
      const grouped = groupEventsByTime(scheduleData);

      allTimes.forEach(time => {
        const row = document.createElement('div');
        row.className = 'time-row';

        const timeLabel = document.createElement('div');
        timeLabel.className = 'time-label';
        timeLabel.textContent = time;

        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'events-container';
        eventsContainer.addEventListener('dragover', handleDragOver);
        eventsContainer.addEventListener('drop', handleDrop);

        (grouped[time] || []).forEach(event => {
          const block = renderEventBlock(event);
          eventsContainer.appendChild(block);
        });

        const addBtn = document.createElement('button');
        addBtn.className = 'add-event-btn';
        addBtn.textContent = '+ Add';
        addBtn.onclick = () => addNewEvent(time);
        eventsContainer.appendChild(addBtn);

        row.appendChild(timeLabel);
        row.appendChild(eventsContainer);
        container.appendChild(row);
      });

      updateStats();
      saveToStorage();
    }

    function renderEventBlock(event) {
      const block = document.createElement('div');
      block.className = `event-block cat-${event.category || 'other'}`;
      block.id = `event-${event.id}`;
      block.draggable = true;

      block.addEventListener('dragstart', handleDragStart);
      block.addEventListener('dragend', handleDragEnd);
      block.addEventListener('click', () => setActiveEvent(event.id));

      const top = document.createElement('div');
      top.className = 'event-top';

      // Category pill (cycles on click)
      const catPill = document.createElement('button');
      catPill.className = 'pill';
      catPill.title = 'Cycle category (C)';
      catPill.textContent = categoryLabel(event.category || 'other');
      catPill.onclick = (e) => { e.stopPropagation(); cycleCategory(event.id); };

      // Repeat pill
      const repPill = document.createElement('button');
      repPill.className = 'pill';
      repPill.title = 'Cycle repeat (R)';
      repPill.textContent = repeatLabel(event.repeat || 'none');
      repPill.onclick = (e) => { e.stopPropagation(); cycleRepeat(event.id); };

      top.appendChild(catPill);
      top.appendChild(repPill);

      // Editable content
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'event-content';
      input.value = event.content;
      input.placeholder = 'Enter event...';
      input.onchange = () => updateEventContent(event.id, input.value);
      input.onkeydown = (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); } };
      input.addEventListener('focus', () => setActiveEvent(event.id));

      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = '×';
      del.onclick = (e) => { e.stopPropagation(); deleteEvent(event.id); };

      block.appendChild(top);
      block.appendChild(input);
      block.appendChild(del);

      // Active styling
      if (event.id === activeEventId) block.classList.add('active');

      return block;
    }

    function setActiveEvent(id) {
      activeEventId = id;
      document.querySelectorAll('.event-block').forEach(el => el.classList.remove('active'));
      const el = document.getElementById(`event-${id}`);
      if (el) el.classList.add('active');
    }

    // =============================
    // EVENT OPERATIONS
    // =============================
    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move';
      const id = parseInt(this.id.split('-')[1]); setActiveEvent(id);
    }
    function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
    function handleDrop(e) {
      e.preventDefault(); e.currentTarget.classList.remove('drag-over');
      if (draggedElement && e.currentTarget.classList.contains('events-container')) {
        const newTime = e.currentTarget.parentElement.querySelector('.time-label').textContent;
        const eventId = parseInt(draggedElement.id.split('-')[1]);
        updateEventTime(eventId, newTime);
        createSchedule();
      }
    }
    function handleDragEnd() { this.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedElement = null; }

    function updateEventTime(id, newTime) { const ev = scheduleData.find(e => e.id === id); if (ev) { ev.time = newTime; saveToStorage(); } }
    function updateEventContent(id, newContent) { const ev = scheduleData.find(e => e.id === id); if (ev) { ev.content = newContent; saveToStorage(); } }
    function deleteEvent(id) { scheduleData = scheduleData.filter(e => e.id !== id); createSchedule(); }
    function addNewEvent(time) {
      const ev = { id: nextId++, time, content: 'New Event', category: 'other', repeat: 'none' };
      scheduleData.push(ev); timeSlots.add(time); createSchedule(); setActiveEvent(ev.id);
    }

    function addTimeSlot(t) {
      if (!/^\d{2}:\d{2}$/.test(t)) return alert('Use HH:MM format');
      timeSlots.add(t);
      createSchedule();
    }

    function cleanEmptySlots() {
      const timesWithEvents = new Set(scheduleData.map(e => e.time));
      timeSlots = new Set([...timeSlots].filter(t => timesWithEvents.has(t)));
      createSchedule();
    }

    function cycleCategory(id) {
      const ev = scheduleData.find(e => e.id === id); if (!ev) return;
      const idx = CATEGORIES.indexOf(ev.category || 'other');
      ev.category = CATEGORIES[(idx + 1) % CATEGORIES.length];
      saveToStorage(); createSchedule(); setActiveEvent(id);
    }

    function cycleRepeat(id) {
      const ev = scheduleData.find(e => e.id === id); if (!ev) return;
      const idx = REPEATS.indexOf(ev.repeat || 'none');
      ev.repeat = REPEATS[(idx + 1) % REPEATS.length];
      saveToStorage(); createSchedule(); setActiveEvent(id);
    }

    // =============================
    // EXPORTS / PRINT
    // =============================
    function exportJSON() {
      const data = { schedule: scheduleData, timeSlots: Array.from(timeSlots) };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `planner-${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function exportText() {
      // Simple readable agenda
      const byTime = groupEventsByTime(scheduleData);
      const times = Object.keys(byTime).sort();
      const lines = [];
      lines.push(`# Agenda — ${document.getElementById('dayDate').textContent}`);
      times.forEach(t => {
        lines.push(`\n${t}`);
        byTime[t].forEach(e => lines.push(`  • ${e.content} [${categoryLabel(e.category)}${e.repeat!=='none' ? `, ${repeatLabel(e.repeat)}`:''}]`));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `agenda-${new Date().toISOString().slice(0,10)}.txt`; a.click();
      URL.revokeObjectURL(url);
    }

    // =============================
    // THEME
    // =============================
    function toggleTheme() {
      const root = document.documentElement;
      const cur = root.getAttribute('data-theme') || 'light';
      const next = cur === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      saveToStorage();
    }

    // =============================
    // STATS
    // =============================
    function updateStats() {
      document.getElementById('eventsCount').textContent = scheduleData.length;
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
      document.getElementById('tzBadge').textContent = `(${tz})`;
    }

    // =============================
    // INIT & EVENT BINDINGS
    // =============================
    function init() {
      createMiniCalendar();
      createSchedule();
      updateTime();
      setInterval(updateTime, 1000);

      // UI controls
      document.getElementById('toggleThemeBtn').onclick = toggleTheme;
      document.getElementById('helpBtn').onclick = () => openHelp(true);
      document.getElementById('closeHelp').onclick = () => openHelp(false);
      document.getElementById('saveBtn').onclick = saveToStorage;
      document.getElementById('exportJsonBtn').onclick = exportJSON;
      document.getElementById('exportTextBtn').onclick = exportText;
      document.getElementById('printBtn').onclick = () => window.print();
      document.getElementById('addTimeSlotBtn').onclick = () => {
        const val = document.getElementById('timeInput').value || nearestSlot();
        addTimeSlot(val);
      };
      document.getElementById('clearEmptySlotsBtn').onclick = cleanEmptySlots;

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); saveToStorage(); return; }
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return; // ignore typing
        if (e.key.toLowerCase() === 'n') { addNewEvent(nearestSlot()); }
        if (e.key.toLowerCase() === 'd') { toggleTheme(); }
        if (e.key.toLowerCase() === 'c' && activeEventId != null) { cycleCategory(activeEventId); }
        if (e.key.toLowerCase() === 'r' && activeEventId != null) { cycleRepeat(activeEventId); }
        if (e.key === 'Delete' && activeEventId != null) { deleteEvent(activeEventId); activeEventId = null; }
        if (e.key === '?' || (e.shiftKey && e.key === '/')) { openHelp(true); }
      });
    }

    function openHelp(show) {
      const m = document.getElementById('helpModal');
      if (show) { m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
      else { m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }
    }

    function nearestSlot() {
      // Round current time to nearest upcoming 30-min slot as HH:MM
      const now = new Date();
      let h = now.getHours();
      let m = now.getMinutes();
      m = m <= 30 ? 30 : 60; // push to next slot
      if (m === 60) { h = (h + 1) % 24; m = 0; }
      const pad = n => String(n).padStart(2,'0');
      const slot = `${pad(h)}:${pad(m)}`;
      timeSlots.add(slot);
      return slot;
    }

    // Kick things off
    init();
  </script>
</body>
</html>
